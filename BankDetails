package com.example.bnaka20242;

import java.sql.*;
import java.util.Scanner;

public class BankDetails {
    private String accNo;
    private String name;
    private String accType;
    private double balance;
    private double flatFee;
    private double percentFee;
    private String bankName;

    public BankDetails(double flatFee, double percentFee, String bankName) {
        this.flatFee = flatFee;
        this.percentFee = percentFee;
        this.bankName = bankName;
    }

    public static BankDetails[] fetchUserDataFromDatabase() {
        return fetchAllUsers();
    }

    public void openAccount() {
        Scanner sc = new Scanner(System.in);
        System.out.print("Enter Account No: ");
        this.accNo = sc.next();
        System.out.print("Enter Account type: ");
        this.accType = sc.next();
        System.out.print("Enter Name: ");
        this.name = sc.next();
        System.out.print("Enter Balance: ");
        this.balance = sc.nextDouble();

        // Save the account details to the database
        saveToDatabase();
    }

    public void showAccount() {
        System.out.println("Account No: " + this.accNo);
        System.out.println("Account type: " + this.accType);
        System.out.println("Name: " + this.name);
        System.out.println("Balance: " + this.balance);
    }

    public boolean search(String accNo) {
        if (this.accNo.equals(accNo)) {
            showAccount();
            return true;
        }
        return false;
    }

    public double deposit(double amount, int feeType) {
        double fee = (feeType == 1) ? flatFee : (amount * percentFee / 100);
        this.balance += (amount - fee);
        updateBalanceInDatabase();
        saveTransaction("Deposit", amount, fee);
        return fee;
    }

    public double withdrawal(double amount, int feeType) {
        double fee = (feeType == 1) ? flatFee : (amount * percentFee / 100);
        if (this.balance >= (amount + fee)) {
            this.balance -= (amount + fee);
            updateBalanceInDatabase();
            saveTransaction("Withdrawal", amount, fee);
            return fee;
        } else {
            System.out.println("Insufficient balance!");
            return 0;
        }
    }

    public double transfer(BankDetails toAccount, double amount, int feeType) {
        double fee = (feeType == 1) ? flatFee : (amount * percentFee / 100);
        if (this.balance >= (amount + fee)) {
            this.balance -= (amount + fee);
            toAccount.balance += amount;
            updateBalanceInDatabase();
            toAccount.updateBalanceInDatabase();
            saveTransaction("Transfer to " + toAccount.accNo, amount, fee);
            toAccount.saveTransaction("Transfer from " + this.accNo, amount, 0);
            return fee;
        } else {
            System.out.println("Insufficient balance!");
            return 0;
        }
    }

    public void showTransactions() {
        // Fetch and display transactions for this account
        String url = "jdbc:mysql://localhost:3306/banking_db";
        String user = "root";
        String password = "a.n8";

        try (Connection conn = DriverManager.getConnection(url, user, password)) {
            String query = "SELECT * FROM transactions WHERE accno = ?";
            PreparedStatement pstmt = conn.prepareStatement(query);
            pstmt.setString(1, this.accNo);
            ResultSet rs = pstmt.executeQuery();

            while (rs.next()) {
                System.out.println("Transaction ID: " + rs.getInt("id"));
                System.out.println("Type: " + rs.getString("type"));
                System.out.println("Amount: " + rs.getDouble("amount"));
                System.out.println("Fee: " + rs.getDouble("fee"));
                System.out.println("Timestamp: " + rs.getTimestamp("timestamp"));
                System.out.println();
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void saveToDatabase() {
        String url = "jdbc:mysql://localhost:3306/banking_db";
        String user = "root";
        String password = "a.n8";

        try (Connection conn = DriverManager.getConnection(url, user, password)) {
            String query = "INSERT INTO users (accno, name, acc_type, balance, bankName) VALUES (?, ?, ?, ?, ?)";
            PreparedStatement pstmt = conn.prepareStatement(query);
            pstmt.setString(1, this.accNo);
            pstmt.setString(2, this.name);
            pstmt.setString(3, this.accType);
            pstmt.setDouble(4, this.balance);
            pstmt.setString(5, this.bankName);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void updateBalanceInDatabase() {
        String url = "jdbc:mysql://localhost:3306/banking_db";
        String user = "root";
        String password = "a.n8";

        try (Connection conn = DriverManager.getConnection(url, user, password)) {
            String query = "UPDATE users SET balance = ? WHERE accno = ?";
            PreparedStatement pstmt = conn.prepareStatement(query);
            pstmt.setDouble(1, this.balance);
            pstmt.setString(2, this.accNo);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    private void saveTransaction(String type, double amount, double fee) {
        String url = "jdbc:mysql://localhost:3306/banking_db";
        String user = "root";
        String password = "a.n8";

        try (Connection conn = DriverManager.getConnection(url, user, password)) {
            String query = "INSERT INTO transactions (accno, type, amount, fee) VALUES (?, ?, ?, ?)";
            PreparedStatement pstmt = conn.prepareStatement(query);
            pstmt.setString(1, this.accNo);
            pstmt.setString(2, type);
            pstmt.setDouble(3, amount);
            pstmt.setDouble(4, fee);
            pstmt.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    public static double getTotalFeesCollected() {
        String url = "jdbc:mysql://localhost:3306/banking_db";
        String user = "root";
        String password = "a.n8";

        double totalFees = 0.0;
        try (Connection conn = DriverManager.getConnection(url, user, password)) {
            String query = "SELECT SUM(fee) AS totalFees FROM transactions";
            PreparedStatement pstmt = conn.prepareStatement(query);
            ResultSet rs = pstmt.executeQuery();
            if (rs.next()) {
                totalFees = rs.getDouble("totalFees");
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return totalFees;
    }

    public static BankDetails[] fetchAllUsers() {
        String url = "jdbc:mysql://localhost:3306/banking_db";
        String user = "root";
        String password = "a.n8";

        try (Connection conn = DriverManager.getConnection(url, user, password)) {
            String query = "SELECT * FROM users";
            PreparedStatement pstmt = conn.prepareStatement(query);
            ResultSet rs = pstmt.executeQuery();

            // Assuming a maximum of 100 users for simplicity
            BankDetails[] users = new BankDetails[100];
            int index = 0;
            while (rs.next()) {
                double flatFee = 0; // These values should be retrieved based on your application's logic
                double percentFee = 0; // These values should be retrieved based on your application's logic
                String bankName = rs.getString("bankName");

                BankDetails userObj = new BankDetails(flatFee, percentFee, bankName);
                userObj.accNo = rs.getString("accno");
                userObj.name = rs.getString("name");
                userObj.accType = rs.getString("acc_type");
                userObj.balance = rs.getDouble("balance");

                users[index++] = userObj;
            }
            return users;
        } catch (SQLException e) {
            e.printStackTrace();
            return new BankDetails[0];
        }
    }
}
